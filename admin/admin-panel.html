<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MVC Mining</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #ffffff;
            --fg: #000000;
            --gray: #666666;
            --border: #e5e5e5;
            --hover: #f5f5f5;
            --primary: #ff6b35;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--fg);
            min-height: 100vh;
            font-size: 14px;
        }

        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .slide-button {
            background: none;
            border: none;
            color: var(--fg);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .slide-button:hover { background: var(--hover); }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .header-logo {
            height: 32px;
            width: auto;
            object-fit: contain;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--gray);
            font-size: 13px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            color: var(--fg);
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .logout-btn:hover { background: #dc2626; }

        .sidebar {
            position: fixed;
            top: 60px;
            left: -50vw;
            width: 50vw;
            height: calc(100vh - 60px);
            background: var(--bg);
            border-right: 1px solid var(--border);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: left 0.3s ease;
            z-index: 999;
            padding: 24px 0;
        }

        .sidebar.open { left: 0; }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            padding: 0 24px;
        }

        .sidebar-nav a {
            display: block;
            padding: 12px 0;
            color: var(--gray);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.2s ease;
            border-bottom: 1px solid transparent;
        }

        .sidebar-nav a:hover { color: var(--fg); }
        .sidebar-nav a.active { color: var(--fg); border-bottom-color: var(--primary); }

        .main-content {
            margin-top: 60px;
            transition: margin-left 0.3s ease;
            min-height: calc(100vh - 60px);
        }

        .main-content.sidebar-open { margin-left: 50vw; }

        .content-frame {
            width: 100%;
            height: calc(100vh - 60px);
            border: none;
            display: none;
        }

        .content-frame.active { display: block; }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.2);
            z-index: 998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 768px) {
            .main-content.sidebar-open { margin-left: 0; }
            .sidebar { width: 100%; left: -100%; }
            .sidebar.open { left: 0; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <span>Authenticating...</span>
    </div>

    <div id="app" class="hidden">
        <header class="header">
            <div class="header-left">
                <button class="slide-button" id="sidebarToggle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="logo-container">
                    <img src="../assets/images/logo.png" alt="MVC Mining Logo" class="header-logo">
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar" id="userInitials">AD</div>
                    <span id="userName">Admin User</span>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

    <nav class="sidebar" id="sidebar">
        <ul class="sidebar-nav">
            <li><a href="#" data-page="dashboard" data-src="./admin-dashboard.html" class="active">Dashboard</a></li>
            <li><a href="#" data-page="users" data-src="./users-management.html">User Management</a></li>
            <li><a href="#" data-page="withdrawals" data-src="./withdraw-approve.html">Withdrawal Requests</a></li>
            <li><a href="#" data-page="bans" data-src="./band-users.html">Banned Users</a></li>
                     <li><a href="#" data-page="approve" data-src="./approve-transction.html">Approve Transaction</a></li>
        </ul>
    </nav>

    <div class="overlay" id="overlay"></div>

    <main class="main-content" id="mainContent">
        <iframe class="content-frame active" id="dashboard-frame" data-page="dashboard"></iframe>
        <iframe class="content-frame" id="users-frame" data-page="users"></iframe>
        <iframe class="content-frame" id="withdrawals-frame" data-page="withdrawals"></iframe>
        <iframe class="content-frame" id="bans-frame" data-page="bans"></iframe>
        <iframe class="content-frame" id="approve-frame" data-page="approve"></iframe>
    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import firebaseConfig from './firebaseConfig.js';

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const $ = id => document.getElementById(id);

        const redirectToLogin = () => {
            window.location.href = './login-admin.html';
        };

        const checkAdminAccess = async (user) => {
            try {
                const userRef = ref(db, `users/${user.uid}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    
                    // Check if user is admin
                    if (userData.role !== 'admin') {
                        alert('Access denied. Admin privileges required.');
                        redirectToLogin();
                        return false;
                    }

                    // Update UI with user info
                    const initials = userData.name ? userData.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'AD';
                    $('userInitials').textContent = initials;
                    $('userName').textContent = userData.name || 'Admin User';
                    
                    return true;
                } else {
                    redirectToLogin();
                    return false;
                }
            } catch (error) {
                console.error('Error checking admin access:', error);
                redirectToLogin();
                return false;
            }
        };

        const initApp = () => {
            $('loadingScreen').classList.add('hidden');
            $('app').classList.remove('hidden');
            showPage('dashboard');
        };

        const showPage = (pageId) => {
            document.querySelectorAll('.content-frame').forEach(frame => frame.classList.remove('active'));
            document.querySelectorAll('.sidebar-nav a').forEach(item => item.classList.remove('active'));
            
            const targetFrame = $(`${pageId}-frame`);
            if (targetFrame) {
                targetFrame.classList.add('active');
                
                const navItem = document.querySelector(`[data-page="${pageId}"]`);
                const srcUrl = navItem?.getAttribute('data-src');
                
                if (srcUrl && !targetFrame.src) {
                    targetFrame.src = srcUrl;
                }
            }
            
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
        };

        // Navigation handlers
        document.querySelectorAll('.sidebar-nav a').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const pageId = this.getAttribute('data-page');
                showPage(pageId);
                
                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    $('sidebar').classList.remove('open');
                    $('mainContent').classList.remove('sidebar-open');
                    $('overlay').classList.remove('active');
                }
            });
        });

        // Sidebar toggle
        $('sidebarToggle').addEventListener('click', () => {
            $('sidebar').classList.toggle('open');
            $('mainContent').classList.toggle('sidebar-open');
            $('overlay').classList.toggle('active');
        });

        $('overlay').addEventListener('click', () => {
            $('sidebar').classList.remove('open');
            $('mainContent').classList.remove('sidebar-open');
            $('overlay').classList.remove('active');
        });

        window.logout = () => {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut().then(() => {
                    redirectToLogin();
                }).catch(() => {
                    redirectToLogin();
                });
            }
        };

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const hasAccess = await checkAdminAccess(user);
                if (hasAccess) {
                    initApp();
                }
            } else {
                redirectToLogin();
            }
        });
    </script>
</body>
</html>