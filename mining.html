<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mining Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #fefbf6;
            color: #171717;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            margin-bottom: 3rem;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #000;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .auth-status {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
        }

        .auth-authenticated {
            background: #dcfce7;
            color: #16a34a;
        }

        .auth-unauthenticated {
            background: #fef2f2;
            color: #dc2626;
        }

        .balance-display {
            margin-bottom: 2rem;
        }

        .balance-label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .balance-amount {
            font-size: 3rem;
            font-weight: 900;
            color: #ea580c;
            margin: 0;
            line-height: 1;
        }

        .mining-section {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .mining-animation {
            width: 120px;
            height: 120px;
            margin: 1rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #fff7ed;
        }

        .mining-icon {
            font-size: 3rem;
            transition: transform 0.3s ease;
        }

        .mining-gif {
            width: 160px;
            height: 160px;
            display: none;
        }

        .mining-status {
            font-size: 1.1rem;
            margin: 1rem 0;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            display: inline-block;
            background: #fff7ed;
            color: #ea580c;
        }

        .status-mining {
            background: #dcfce7;
            color: #16a34a;
        }

        .btn {
            background: #ea580c;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            margin: 0.5rem;
        }

        .btn:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #e5e5e5;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #16a34a;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #15803d;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
        }

        .stat-card.mining-active {
            border-color: #16a34a;
            background: #f0fdf4;
        }

        .stat-title {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #000;
        }

        .withdraw-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            background: #16a34a;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .withdraw-btn:disabled {
            background: #e5e5e5;
            color: #999;
            cursor: not-allowed;
        }

        .progress-section {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: none;
        }

        .progress-section.active {
            display: block;
            border-color: #16a34a;
            background: #f0fdf4;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .countdown {
            font-size: 0.9rem;
            color: #ea580c;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e5e5;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #16a34a, #22c55e);
            transition: width 0.3s ease;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }

        .overall-progress {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e5e5;
        }

        .transactions {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            overflow: hidden;
        }

        .transactions-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e5e5;
            background: #fafafa;
        }

        .transactions-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .transaction-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .transaction-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-type {
            font-weight: 500;
            color: #000;
        }

        .transaction-date {
            color: #666;
            font-size: 0.9rem;
        }

        .transaction-amount {
            font-weight: 600;
        }

        .transaction-amount.positive {
            color: #16a34a;
        }

        .transaction-amount.negative {
            color: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .auth-status {
                position: relative;
                margin: 0.5rem;
            }

            .progress-header {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="auth-status" id="authStatus">Checking...</div>
            <h1>⛏️ Mining Dashboard</h1>
            <p id="currentLevelText">Current Level: -</p>
        </div>

        <div class="balance-display">
            <div class="balance-label">Current Balance</div>
            <div class="balance-amount">$<span id="balance">0.00</span></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card" id="totalEarnedCard">
                <button class="withdraw-btn" id="withdrawBtn" onclick="withdrawEarnings()">Withdraw</button>
                <div class="stat-title">Total Earned</div>
                <div class="stat-value">$<span id="totalEarned">0.00</span></div>
            </div>
            <div class="stat-card" id="sessionsCard">
                <div class="stat-title">Mining Sessions</div>
                <div class="stat-value" id="sessions">0</div>
            </div>
            <div class="stat-card" id="pendingCard">
                <div class="stat-title">Pending Rewards</div>
                <div class="stat-value">$<span id="pendingEarned">0.00</span></div>
            </div>
            <div class="stat-card" id="levelCard">
                <div class="stat-title">Mining Level</div>
                <div class="stat-value" id="currentLevel">-</div>
            </div>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-header">
                <div class="progress-title">Daily Mining Session</div>
                <div class="countdown" id="sessionCountdown">00:00:00</div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="sessionProgress"></div>
            </div>
            <div class="progress-info">
                <span id="sessionStatus">Ready</span>
                <span id="sessionTime">0 / 4 hours</span>
            </div>

            <div class="overall-progress">
                <div class="progress-header">
                    <div class="progress-title">Overall Progress</div>
                    <div class="countdown" id="overallCountdown">50 days left</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="overallProgress"></div>
                </div>
                <div class="progress-info">
                    <span id="overallStatus">Day 0 / 50</span>
                    <span id="overallEarned">$0.00 earned</span>
                </div>
            </div>
        </div>

        <div class="mining-section">
            <div class="mining-animation">
                <div class="mining-icon" id="miningIcon">⛏️</div>
                <img src="mining.gif" alt="Mining" class="mining-gif" id="miningGif" onerror="this.style.display='none';">
            </div>
            
            <div class="mining-status" id="status">Ready to Mine</div>
            <button class="btn" id="miningBtn" onclick="toggleMining()">Start Mining</button>
        </div>

        <div class="transactions">
            <div class="transactions-header">
                <h3>Mining Transactions</h3>
            </div>
            <div class="transaction-list" id="transactionList">
                <div class="empty-state">
                    <p>No mining transactions yet. Start your first mining session!</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, onValue, set, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import firebaseConfig from './firebaseConfig.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const firestore = getFirestore(app);

        let currentUser = null;
        let userData = { wallet: { usdBalance: 0 }, totalEarned: 0, sessions: 0, level: null, miningState: null };
        let LEVELS = {};
        let updateTimer = null;
        let payoutTimer = null;
        let isMining = false;

        const MINING_DURATION = 4 * 60 * 60 * 1000; // 4 hours
        const TOTAL_DAYS = 50;
        const DAY_DURATION = 24 * 60 * 60 * 1000; // 24 hours

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const authStatus = document.getElementById('authStatus');
            const btn = document.getElementById('miningBtn');
            
            if (user) {
                authStatus.textContent = `✓ ${user.email}`;
                authStatus.className = 'auth-status auth-authenticated';
                btn.disabled = false;
                loadUserData();
                loadLevels();
            } else {
                authStatus.textContent = '❌ Not Authenticated';
                authStatus.className = 'auth-status auth-unauthenticated';
                btn.disabled = true;
                btn.textContent = 'Login Required';
                resetDisplay();
            }
        });

        function loadLevels() {
            const levelsRef = ref(database, 'levels');
            onValue(levelsRef, (snapshot) => {
                LEVELS = snapshot.exists() ? snapshot.val() : {
                    1: { cost: 500, income: 20 },
                    2: { cost: 900, income: 36 },
                    3: { cost: 1500, income: 46 },
                    4: { cost: 45000, income: 180 }
                };
                updateDisplay();
            });
        }

        function loadUserData() {
            const userRef = ref(database, `users/${currentUser.uid}`);
            onValue(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    userData = { ...userData, ...snapshot.val() };
                    if (userData.miningState?.isActive && Date.now() < userData.miningState.endTime) {
                        resumeMining();
                    } else if (userData.miningState?.isActive) {
                        completeMining();
                    }
                } else {
                    const newUserData = {
                        profile: { email: currentUser.email, uid: currentUser.uid },
                        wallet: { usdBalance: 0 },
                        totalEarned: 0,
                        sessions: 0,
                        level: null
                    };
                    set(userRef, newUserData);
                    userData = { ...userData, ...newUserData };
                }
                updateDisplay();
            });
            loadTransactions();
        }

        function loadTransactions() {
            const txRef = collection(firestore, 'users', currentUser.uid, 'transactions');
            onSnapshot(txRef, (snapshot) => {
                const txs = snapshot.docs
                    .map(doc => ({ ...doc.data(), id: doc.id }))
                    .sort((a, b) => (b.timestamp?.toDate() || new Date(b.date)) - (a.timestamp?.toDate() || new Date(a.date)))
                    .slice(0, 10);
                updateTransactionList(txs);
            });
        }

        function updateDisplay() {
            const level = LEVELS[userData.level];
            
            document.getElementById('balance').textContent = (userData.wallet?.usdBalance || 0).toFixed(2);
            document.getElementById('totalEarned').textContent = (userData.totalEarned || 0).toFixed(2);
            document.getElementById('sessions').textContent = userData.sessions || 0;
            document.getElementById('pendingEarned').textContent = (userData.miningState?.pendingEarned || 0).toFixed(2);
            document.getElementById('currentLevel').textContent = userData.level || '-';
            
            // Update withdraw button
            const withdrawBtn = document.getElementById('withdrawBtn');
            const canWithdraw = (userData.totalEarned || 0) >= 500;
            withdrawBtn.disabled = !canWithdraw;
            withdrawBtn.textContent = canWithdraw ? 'Withdraw' : '$500 min';
            
            if (!level || !userData.level) {
                document.getElementById('currentLevelText').textContent = 'Upgrade Plan Required';
                document.getElementById('miningBtn').textContent = 'Upgrade Plan';
            } else {
                document.getElementById('currentLevelText').textContent = `Level ${userData.level} - Cost: $${level.cost}`;
                if (!isMining && !userData.miningState?.isActive) {
                    document.getElementById('miningBtn').textContent = 'Start Mining';
                }
            }

            updateMiningDisplay();
        }

        function updateMiningDisplay() {
            const progressSection = document.getElementById('progressSection');
            const isActive = userData.miningState?.isActive;
            
            progressSection.classList.toggle('active', isActive);
            
            ['totalEarnedCard', 'sessionsCard', 'pendingCard', 'levelCard'].forEach(id => {
                document.getElementById(id).classList.toggle('mining-active', isActive);
            });

            if (!isActive) return;

            const now = Date.now();
            const { startTime, endTime, dailyMiningStart, dailyMiningActive } = userData.miningState;
            
            const daysSinceStart = Math.floor((now - startTime) / DAY_DURATION);
            const currentDay = Math.min(TOTAL_DAYS, daysSinceStart + 1);
            
            if (dailyMiningActive && dailyMiningStart) {
                const sessionElapsed = now - dailyMiningStart;
                const sessionProgress = Math.min(100, (sessionElapsed / MINING_DURATION) * 100);
                const sessionTimeLeft = Math.max(0, MINING_DURATION - sessionElapsed);
                
                document.getElementById('sessionProgress').style.width = `${sessionProgress}%`;
                document.getElementById('sessionCountdown').textContent = formatTime(sessionTimeLeft);
                document.getElementById('sessionStatus').textContent = 'Mining Active';
                document.getElementById('sessionTime').textContent = `${Math.floor(sessionElapsed / (60 * 60 * 1000))} / 4 hours`;
            } else {
                document.getElementById('sessionProgress').style.width = '0%';
                document.getElementById('sessionCountdown').textContent = 'Waiting';
                document.getElementById('sessionStatus').textContent = 'Ready';
                document.getElementById('sessionTime').textContent = '0 / 4 hours';
            }
            
            const overallProgress = (currentDay / TOTAL_DAYS) * 100;
            const timeLeft = Math.max(0, endTime - now);
            
            document.getElementById('overallProgress').style.width = `${overallProgress}%`;
            document.getElementById('overallCountdown').textContent = formatTime(timeLeft);
            document.getElementById('overallStatus').textContent = `Day ${currentDay} / ${TOTAL_DAYS}`;
            document.getElementById('overallEarned').textContent = `$${(userData.miningState.pendingEarned || 0).toFixed(2)} earned`;
        }

        function updateTransactionList(txs = []) {
            const list = document.getElementById('transactionList');
            if (txs.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>No mining transactions yet. Start your first mining session!</p></div>';
            } else {
                list.innerHTML = txs.map(tx => `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-type">${getTransactionType(tx.type)}</div>
                            <div class="transaction-date">${new Date(tx.timestamp?.toDate() || tx.date).toLocaleString()}</div>
                        </div>
                        <div class="transaction-amount ${tx.amount < 0 ? 'negative' : 'positive'}">
                            ${tx.amount >= 0 ? '+' : ''}$${Math.abs(tx.amount).toFixed(2)}
                        </div>
                    </div>
                `).join('');
            }
        }

        function getTransactionType(type) {
            const types = {
                cost: 'Mining Cost',
                payout: 'Mining Payout',
                reward: 'Mining Reward',
                complete: 'Mining Complete',
                withdraw: 'Withdrawal'
            };
            return types[type] || 'Mining Transaction';
        }

        function resetDisplay() {
            ['balance', 'totalEarned', 'pendingEarned'].forEach(id => 
                document.getElementById(id).textContent = '0.00');
            ['sessions', 'currentLevel'].forEach(id => 
                document.getElementById(id).textContent = '0');
            document.getElementById('currentLevelText').textContent = 'Current Level: -';
            document.getElementById('withdrawBtn').disabled = true;
            document.getElementById('transactionList').innerHTML = '<div class="empty-state"><p>Please authenticate to view mining data</p></div>';
        }

        window.toggleMining = function() {
            if (!userData.level || !LEVELS[userData.level]) {
                updateStatus('Please upgrade your plan to start mining');
                return;
            }
            
            if (isMining || userData.miningState?.isActive) {
                stopMining();
            } else {
                startMining();
            }
        }

        window.withdrawEarnings = function() {
            if (!currentUser || (userData.totalEarned || 0) < 500) {
                alert('Minimum withdrawal amount is $500');
                return;
            }
            
            const amount = userData.totalEarned;
            if (confirm(`Withdraw $${amount.toFixed(2)} to your main balance?`)) {
                userData.wallet.usdBalance += amount;
                userData.totalEarned = 0;
                saveUserData();
                saveTransaction({ type: 'withdraw', amount: amount });
                updateDisplay();
            }
        }

        function startMining() {
            if (!currentUser || !userData.level) {
                updateStatus('Authentication or level required');
                return;
            }
            
            const level = LEVELS[userData.level];
            if (userData.wallet.usdBalance < level.cost) {
                updateStatus(`Insufficient funds - Need $${level.cost}`);
                return;
            }
            
            const totalIncome = level.income * TOTAL_DAYS;
            const confirmMsg = `Start ${TOTAL_DAYS}-Day Mining Plan?\n\nLevel: ${userData.level}\nCost: $${level.cost}\nTotal Income: $${totalIncome}\nProfit: $${totalIncome - level.cost}`;
            
            if (!confirm(confirmMsg)) return;
            
            userData.wallet.usdBalance -= level.cost;
            userData.miningState = {
                isActive: true,
                level: userData.level,
                startTime: Date.now(),
                endTime: Date.now() + (TOTAL_DAYS * DAY_DURATION),
                pendingEarned: 0,
                income: level.income,
                dailyMiningStart: 0,
                dailyMiningActive: false,
                daysCompleted: 0
            };
            
            saveUserData();
            saveTransaction({ type: 'cost', amount: -level.cost, level: userData.level });
            resumeMining();
        }

        function resumeMining() {
            isMining = true;
            updateStatus(`Mining Active - Level ${userData.miningState.level}`, true);
            document.getElementById('miningBtn').textContent = 'Stop Mining';
            
            document.getElementById('miningIcon').style.display = 'none';
            document.getElementById('miningGif').style.display = 'block';
            
            updateTimer = setInterval(updateMiningDisplay, 1000);
            payoutTimer = setInterval(processPayout, 30000);
        }

        function stopMining() {
            if (confirm('Are you sure you want to stop mining? All progress will be lost!')) {
                clearInterval(updateTimer);
                clearInterval(payoutTimer);
                userData.miningState = null;
                saveUserData();
                resetMiningUI();
                updateStatus('Mining stopped');
            }
        }

        function processPayout() {
            if (!userData.miningState?.isActive) return;
            
            const now = Date.now();
            
            if (now >= userData.miningState.endTime) {
                completeMining();
                return;
            }
            
            if (!userData.miningState.dailyMiningActive) {
                userData.miningState.dailyMiningActive = true;
                userData.miningState.dailyMiningStart = now;
                saveUserData();
            }
            
            const sessionElapsed = now - userData.miningState.dailyMiningStart;
            if (sessionElapsed >= MINING_DURATION && userData.miningState.dailyMiningActive) {
                userData.miningState.dailyMiningActive = false;
                userData.miningState.pendingEarned += userData.miningState.income;
                userData.miningState.daysCompleted++;
                saveUserData();
                updateDisplay();
            }
        }

        function completeMining() {
            if (userData.miningState?.pendingEarned > 0) {
                userData.totalEarned += userData.miningState.pendingEarned;
                saveTransaction({ 
                    type: 'complete', 
                    amount: userData.miningState.pendingEarned, 
                    level: userData.miningState.level 
                });
            }
            
            userData.miningState = null;
            userData.sessions++;
            saveUserData();
            resetMiningUI();
            updateStatus('Mining Complete! Earnings added to Total Earned.');
        }

        function resetMiningUI() {
            isMining = false;
            clearInterval(updateTimer);
            clearInterval(payoutTimer);
            document.getElementById('miningBtn').textContent = 'Start Mining';
            document.getElementById('miningIcon').style.display = 'block';
            document.getElementById('miningGif').style.display = 'none';
            updateStatus('Ready to Mine');
        }

        function updateStatus(message, isMining = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `mining-status ${isMining ? 'status-mining' : ''}`;
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes.toString().padStart(2, '0')}m`;
            }
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        async function saveUserData() {
            if (!currentUser) return;
            try {
                await update(ref(database, `users/${currentUser.uid}`), { 
                    ...userData, 
                    lastUpdated: Date.now() 
                });
            } catch (e) { 
                console.error('Save error:', e); 
            }
        }

        async function saveTransaction(data) {
            if (!currentUser) return;
            try {
                await addDoc(collection(firestore, 'users', currentUser.uid, 'transactions'), {
                    ...data,
                    timestamp: serverTimestamp(),
                    userId: currentUser.uid,
                    date: new Date().toLocaleString()
                });
            } catch (e) { 
                console.error('Transaction error:', e); 
            }
        }
    </script>
</body>
</html>