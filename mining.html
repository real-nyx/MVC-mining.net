<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mining Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #fefbf6;
            color: #171717;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            margin-bottom: 3rem;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #000;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .auth-status {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
        }

        .auth-authenticated {
            background: #dcfce7;
            color: #16a34a;
        }

        .auth-unauthenticated {
            background: #fef2f2;
            color: #dc2626;
        }

        .balance-display {
            margin-bottom: 2rem;
        }

        .balance-label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .balance-amount {
            font-size: 3rem;
            font-weight: 900;
            color: #ea580c;
            margin: 0;
            line-height: 1;
        }

        .mining-section {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .mining-animation {
            width: 200px;
            height: 150px;
            margin: 1rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mining-placeholder {
            font-size: 4rem;
            color: #ea580c;
            transition: transform 0.3s ease;
        }

        .mining-placeholder.mining {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .countdown {
            font-size: 2rem;
            font-weight: 600;
            margin: 1rem 0;
            color: #ea580c;
            display: none;
        }

        .mining-status {
            font-size: 1.1rem;
            margin: 1rem 0;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            display: inline-block;
            background: #fff7ed;
            color: #ea580c;
        }

        .status-mining {
            background: #dcfce7;
            color: #16a34a;
        }

        .btn {
            background: #ea580c;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .btn:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #e5e5e5;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .stat-card.mining-active {
            border-color: #16a34a;
            background: #f0fdf4;
        }

        .stat-title {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #000;
        }

        .mining-progress {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: none;
        }

        .mining-progress.active {
            display: block;
            border-color: #16a34a;
            background: #f0fdf4;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e5e5;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #16a34a, #22c55e);
            transition: width 0.3s ease;
        }

        .transactions {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            overflow: hidden;
        }

        .transactions-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e5e5;
            background: #fafafa;
        }

        .transactions-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .transaction-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .transaction-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-type {
            font-weight: 500;
            color: #000;
        }

        .transaction-date {
            color: #666;
            font-size: 0.9rem;
        }

        .transaction-amount {
            font-weight: 600;
        }

        .transaction-amount.positive {
            color: #16a34a;
        }

        .transaction-amount.negative {
            color: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .countdown {
                font-size: 1.5rem;
            }

            .auth-status {
                position: relative;
                margin: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="auth-status" id="authStatus">Checking...</div>
            <h1>⛏️ Mining Dashboard</h1>
            <p id="currentLevelText">Current Level: -</p>
        </div>

        <div class="balance-display">
            <div class="balance-label">Current Balance</div>
            <div class="balance-amount">$<span id="balance">0.00</span></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card" id="balanceCard">
                <div class="stat-title">Total Mined</div>
                <div class="stat-value">$<span id="totalMined">0.00</span></div>
            </div>
            <div class="stat-card" id="sessionsCard">
                <div class="stat-title">Mining Sessions</div>
                <div class="stat-value" id="sessions">0</div>
            </div>
            <div class="stat-card" id="rateCard">
                <div class="stat-title">Income Per 4H</div>
                <div class="stat-value">$<span id="currentRate">0.00</span></div>
            </div>
            <div class="stat-card" id="earnedCard">
                <div class="stat-title">Pending Earned</div>
                <div class="stat-value">$<span id="sessionEarned">0.00</span></div>
            </div>
        </div>

        <div class="mining-progress" id="miningProgress">
            <h3>Mining Progress</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">0% complete</p>
        </div>

        <div class="mining-section">
            <div class="mining-animation">
                <div class="mining-placeholder" id="miningPlaceholder">⛏️</div>
            </div>
            
            <div class="mining-status" id="status">Ready to Mine</div>
            <div class="countdown" id="countdown">50d 00h 00m</div>
            <button class="btn" id="miningBtn" onclick="toggleMining()">Start Mining</button>
        </div>

        <div class="transactions">
            <div class="transactions-header">
                <h3>Mining Transactions</h3>
            </div>
            <div class="transaction-list" id="transactionList">
                <div class="empty-state">
                    <p>No mining transactions yet. Start your first mining session!</p>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, onValue, set, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import firebaseConfig from './firebaseConfig.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const firestore = getFirestore(app);

    let isMining = false;
    let payoutTimer = null;
    let countdownTimer = null;
    let currentUser = null;
    let userData = { 
        wallet: { usdBalance: 0 }, 
        totalMined: 0, 
        sessions: 0, 
        level: null, 
        miningState: null 
    };
    let LEVELS = {};

    // Load levels from database
    function loadLevels() {
        const levelsRef = ref(database, 'levels');
        onValue(levelsRef, (snapshot) => {
            if (snapshot.exists()) {
                LEVELS = snapshot.val();
            } else {
                // Fallback levels if not in database
                LEVELS = {
                    1: { cost: 500, income: 20 },
                    2: { cost: 900, income: 36 },
                    3: { cost: 1500, income: 46 },
                    4: { cost: 45000, income: 180 }
                };
                set(ref(database, 'levels'), LEVELS);
            }
            updateDisplay();
        });
    }

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        const authStatus = document.getElementById('authStatus');
        const btn = document.getElementById('miningBtn');
        
        if (user) {
            authStatus.textContent = `✓ ${user.email}`;
            authStatus.className = 'auth-status auth-authenticated';
            btn.disabled = false;
            loadUserData();
            loadLevels();
        } else {
            authStatus.textContent = '❌ Not Authenticated';
            authStatus.className = 'auth-status auth-unauthenticated';
            btn.disabled = true;
            btn.textContent = 'Login Required';
            resetDisplay();
        }
    });

    function loadUserData() {
        const userRef = ref(database, `users/${currentUser.uid}`);
        onValue(userRef, (snapshot) => {
            if (snapshot.exists()) {
                userData = { ...userData, ...snapshot.val() };
                // Ensure user has a level assigned
                if (!userData.level) {
                    alert('No mining level assigned to your account. Please contact support.');
                    return;
                }
                if (userData.miningState?.isActive && Date.now() < userData.miningState.endTime) {
                    resumeMining();
                } else if (userData.miningState?.isActive) {
                    completeMining();
                }
            } else {
                // New user - don't set default level, require admin assignment
                alert('Account not found. Please contact support to activate your mining level.');
                return;
            }
            updateDisplay();
        });
        loadTransactions();
    }

    function loadTransactions() {
        const txRef = collection(firestore, 'users', currentUser.uid, 'transactions');
        onSnapshot(txRef, (snapshot) => {
            const txs = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }))
                .sort((a, b) => (b.timestamp?.toDate() || new Date(b.date)) - (a.timestamp?.toDate() || new Date(a.date)))
                .slice(0, 10);
            updateTransactionList(txs);
        });
    }

    function updateDisplay() {
        const level = LEVELS[userData.level];
        if (!level || !userData.level) {
            document.getElementById('balance').textContent = userData.wallet?.usdBalance?.toFixed(2) || '0.00';
            document.getElementById('totalMined').textContent = userData.totalMined?.toFixed(2) || '0.00';
            document.getElementById('sessions').textContent = userData.sessions || '0';
            document.getElementById('currentLevelText').textContent = 'No Level Assigned - Contact Support';
            document.getElementById('currentRate').textContent = '0.00';
            document.getElementById('sessionEarned').textContent = '0.00';
            document.getElementById('miningBtn').disabled = true;
            document.getElementById('miningBtn').textContent = 'Level Required';
            return;
        }

        document.getElementById('balance').textContent = userData.wallet.usdBalance.toFixed(2);
        document.getElementById('totalMined').textContent = userData.totalMined.toFixed(2);
        document.getElementById('sessions').textContent = userData.sessions;
        document.getElementById('currentLevelText').textContent = `Level ${userData.level} - Cost: $${level.cost}`;
        document.getElementById('currentRate').textContent = level.income.toFixed(2);
        document.getElementById('sessionEarned').textContent = (userData.miningState?.pendingEarned || 0).toFixed(2);
        
        // Enable mining button if user has valid level
        document.getElementById('miningBtn').disabled = false;
        if (!isMining && !userData.miningState?.isActive) {
            document.getElementById('miningBtn').textContent = 'Start Mining';
        }
        
        // Update card states
        const isActive = userData.miningState?.isActive;
        ['balanceCard', 'sessionsCard', 'rateCard', 'earnedCard'].forEach(id => {
            document.getElementById(id).classList.toggle('mining-active', isActive);
        });
        
        // Update progress
        const progress = document.getElementById('miningProgress');
        if (isActive) {
            progress.classList.add('active');
            const elapsed = Date.now() - userData.miningState.startTime;
            const total = userData.miningState.endTime - userData.miningState.startTime;
            const pct = Math.min(100, (elapsed / total) * 100);
            document.getElementById('progressFill').style.width = `${pct}%`;
            document.getElementById('progressText').textContent = `${pct.toFixed(1)}% complete`;
        } else {
            progress.classList.remove('active');
        }
    }

    function updateTransactionList(txs = []) {
        const list = document.getElementById('transactionList');
        if (txs.length === 0) {
            list.innerHTML = '<div class="empty-state"><p>No mining transactions yet. Start your first mining session!</p></div>';
        } else {
            list.innerHTML = txs.map(tx => `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-type">${tx.type === 'cost' ? 'Mining Cost' : tx.type === 'payout' ? 'Mining Payout' : 'Mining Reward'}</div>
                        <div class="transaction-date">${new Date(tx.timestamp?.toDate() || tx.date).toLocaleString()}</div>
                    </div>
                    <div class="transaction-amount ${tx.amount < 0 ? 'negative' : 'positive'}">
                        ${tx.amount >= 0 ? '+' : ''}$${Math.abs(tx.amount).toFixed(2)}
                    </div>
                </div>
            `).join('');
        }
    }

    function resetDisplay() {
        ['balance', 'totalMined', 'sessions', 'currentRate', 'sessionEarned'].forEach(id => 
            document.getElementById(id).textContent = '0.00');
        document.getElementById('currentLevelText').textContent = 'Current Level: -';
        document.getElementById('transactionList').innerHTML = '<div class="empty-state"><p>Please authenticate to view mining data</p></div>';
    }

    window.toggleMining = function() {
        if (isMining || userData.miningState?.isActive) {
            stopMining();
        } else {
            startMining();
        }
    }

    function startMining() {
        if (!currentUser) return alert('Please authenticate to start mining');
        
        if (!userData.level) {
            return alert('No mining level assigned to your account. Please contact support.');
        }
        
        const level = LEVELS[userData.level];
        if (!level) return alert('Invalid level configuration. Please contact support.');
        
        if (userData.wallet.usdBalance < level.cost) {
            return alert(`Insufficient Funds!\nRequired: $${level.cost}\nBalance: $${userData.wallet.usdBalance.toFixed(2)}`);
        }
        
        const totalIncome = level.income * 300; // 50 days * 6 payouts per day (every 4 hours)
        const confirmMsg = `Start 50-Day Mining?\n\nLevel: ${userData.level}\nCost: $${level.cost}\nTotal Income: $${totalIncome}\nIncome per 4 hours: $${level.income}\nProfit: $${totalIncome - level.cost}`;
        
        if (!confirm(confirmMsg)) return;
        
        // Deduct cost
        userData.wallet.usdBalance -= level.cost;
        
        // Set mining state
        const now = Date.now();
        userData.miningState = {
            isActive: true,
            level: userData.level,
            startTime: now,
            endTime: now + (50 * 24 * 60 * 60 * 1000), // 50 days
            lastPayout: now,
            pendingEarned: 0,
            income: level.income
        };
        
        saveUserData();
        saveTransaction({ type: 'cost', amount: -level.cost, level: userData.level });
        resumeMining();
    }

    function resumeMining() {
        isMining = true;
        document.getElementById('miningBtn').textContent = 'Stop Mining';
        document.getElementById('miningPlaceholder').classList.add('mining');
        document.getElementById('status').textContent = `Mining Active - Level ${userData.miningState.level}`;
        document.getElementById('status').className = 'mining-status status-mining';
        document.getElementById('countdown').style.display = 'block';
        
        countdownTimer = setInterval(updateMiningDisplay, 1000);
        payoutTimer = setInterval(processPayout, 60000); // Check every minute
    }

    function stopMining() {
        if (confirm('Are you sure you want to stop mining? All pending earnings will be lost!')) {
            isMining = false;
            clearInterval(payoutTimer);
            clearInterval(countdownTimer);
            userData.miningState = null;
            saveUserData();
            resetMiningDisplay();
        }
    }

    function processPayout() {
        if (!userData.miningState?.isActive) return;
        
        const now = Date.now();
        const fourHours = 4 * 60 * 60 * 1000; // 4 hours in milliseconds
        
        // Check if mining period is complete
        if (now >= userData.miningState.endTime) {
            completeMining();
            return;
        }
        
        // Check if 4 hours have passed since last payout
        if (now - userData.miningState.lastPayout >= fourHours) {
            userData.miningState.pendingEarned += userData.miningState.income;
            userData.miningState.lastPayout = now;
            saveUserData();
            updateDisplay();
        }
    }

    function updateMiningDisplay() {
        if (!userData.miningState?.isActive) return;
        
        const timeLeft = Math.max(0, userData.miningState.endTime - Date.now());
        if (timeLeft <= 0) {
            completeMining();
            return;
        }
        
        const days = Math.floor(timeLeft / (24 * 60 * 60 * 1000));
        const hours = Math.floor((timeLeft % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
        const minutes = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
        
        document.getElementById('countdown').textContent = `${days}d ${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m`;
        
        // Show next payout countdown
        const nextPayout = (4 * 60 * 60 * 1000) - ((Date.now() - userData.miningState.lastPayout) % (4 * 60 * 60 * 1000));
        const nextHours = Math.floor(nextPayout / (60 * 60 * 1000));
        const nextMinutes = Math.floor((nextPayout % (60 * 60 * 1000)) / (60 * 1000));
        document.getElementById('status').textContent = `Mining Active - Next payout in ${nextHours}h ${nextMinutes}m`;
    }

    function completeMining() {
        // Transfer pending earnings to balance
        if (userData.miningState?.pendingEarned > 0) {
            userData.wallet.usdBalance += userData.miningState.pendingEarned;
            userData.totalMined += userData.miningState.pendingEarned;
            saveTransaction({ 
                type: 'payout', 
                amount: userData.miningState.pendingEarned, 
                level: userData.miningState.level 
            });
        }
        
        userData.miningState = null;
        userData.sessions++;
        saveUserData();
        resetMiningDisplay();
        
        document.getElementById('status').textContent = 'Mining Complete!';
        setTimeout(() => document.getElementById('status').textContent = 'Ready to Mine', 3000);
    }

    function resetMiningDisplay() {
        isMining = false;
        document.getElementById('miningBtn').textContent = 'Start Mining';
        document.getElementById('miningPlaceholder').classList.remove('mining');
        document.getElementById('status').textContent = 'Ready to Mine';
        document.getElementById('status').className = 'mining-status';
        document.getElementById('countdown').style.display = 'none';
        clearInterval(payoutTimer);
        clearInterval(countdownTimer);
    }

    async function saveUserData() {
        if (!currentUser) return;
        try {
            await update(ref(database, `users/${currentUser.uid}`), { 
                ...userData, 
                lastUpdated: Date.now() 
            });
        } catch (e) { 
            console.error('Save error:', e); 
        }
    }

    async function saveTransaction(data) {
        if (!currentUser) return;
        try {
            await addDoc(collection(firestore, 'users', currentUser.uid, 'transactions'), {
                ...data,
                timestamp: serverTimestamp(),
                userId: currentUser.uid,
                date: new Date().toLocaleString()
            });
        } catch (e) { 
            console.error('Transaction error:', e); 
        }
    }
</script>
</body>
</html>